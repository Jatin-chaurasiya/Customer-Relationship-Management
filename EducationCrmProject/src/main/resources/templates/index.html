<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CampusConnect</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
	crossorigin="anonymous">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
	<!--HEADER START-->
	<div th:if="${sessionUser == null OR sessionUser == ''}">
		<div th:replace="~{fragments/header :: header}"></div>
	</div>
	<div th:unless="${sessionUser == null OR sessionUser == ''}">
		<div th:replace="~{fragments/headerProfile :: header}"></div>
	</div>
	<!-- Header Ends -->

	<!--Main  section Start-->
	<main class="container-fluid">
		<!--Banner-->
		<section>
			<img src="images/banner.jpg" alt="CampusConnect Banner"
				class="img-fluid w-100" />
		</section>

		<!--content-->
		<section class="container py-5 bg-light">
			<h3 class="text-center mb-5">Our Courses</h3>

			<!--Courses-->
			<div class="row g-4">
				<!-- removed justify-content-center -->

				<!--one course card start-->
				<div th:each="course : ${courseList}"
					class="col-lg-3 col-md-6 shadow-sm">
					<div class="card h-100 shadow-sm">
						<img th:src="@{${course.imageUrl}}" class="card-img-top"
							alt="course Img">
						<div class="card-body">
							<h5 class="card-title">
								<span th:text="${course.name}"></span>
							</h5>
							<p class="card-text">
								<span th:text="${course.description}"></span>
							</p>
							<!-- Price row -->
							<p>
								<strong>Price : </strong>
								<del>
									Rs. <span th:text="${course.originalPrice}">></span>
								</del>
								<span class="bg-info text-white">Rs. <span
									th:text="${course.discountedPrice}"></span></span>
							</p>
							<!-- Button -->
							<div th:if="${sessionUser == null OR sessionUser == ''}">
								<a href="#" class="btn btn-outline-primary px-4">Login to
									Buy</a>
							</div>
							<div th:unless="${sessionUser == null OR sessionUser == ''}">
								<div
									th:if="${#lists.contains(purchasedCourseNameList, course.name)}">
									<span class="text-success">Course already Purchased</span>
								</div>
								<div
									th:unless="${#lists.contains(purchasedCourseNameList,course.name)}">
									<button  class="btn btn-outline-primary px-4"
										th:data-cname="${course.name}"
										th:data-uname="${sessionUser.name}"
										th:data-uemail="${sessionUser.email}"
										th:data-uphoneno="${sessionUser.phoneno}"
										th:data-camount="${course.discountedPrice}"
										onclick="purchaseCourse(this.getAttribute('data-camount'),
                        this.getAttribute('data-uname'),
                        this.getAttribute('data-uemail'),
                        this.getAttribute('data-uphoneno'),
                        this.getAttribute('data-cname'))">
										Buy</button>
								</div>

							</div>
						</div>
						<div class="card-footer text-muted">
							Update : <span th:text="${course.updateOn}"></span>
						</div>
					</div>
				</div>
				<!--one course card end-->
			</div>
		</section>
	</main>

	<!--Main section ends-->

	<!--Footer starts-->
	<div th:replace="~{fragments/footer :: footer}"></div>
	<!--Footer ends-->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
		crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
	<script>
		function purchaseCourse(courseAmount, uname, uemail, uphoneno,
				courseName) {
			var options = {
				"key" : "rzp_test_R8jbIJWbxXJTNi",
				"amount" : courseAmount * 100,
				"currency" : "INR",
				"name" : "CampusConnect",
				"description" : "Course Transaction",
				"image" : "https://resources.ca.gov/-/media/CNRA-Website/Images/About/Campus-Connect/Campus-Connect-Logos-Color-and-White.png?h=300&w=300&hash=152C85F11A92AC88B781E60653216FCA",
				"handler" : function(response) {
					console.log(response);
					alert("Payment Successful");
					
					var date = new Date();
					var dateofPurchase = date.toLocaleDateString('en-GB')+","+date.toLocaleTimeString('en-GB',{hour12: true});

					var requestData = {
						courseName : courseName,
						courseAmount : courseAmount,
						userEmail : uemail,
						dateofPurchase : dateofPurchase,
						paymentId : response.razorpay_payment_id
					};

					$
							.ajax({
								type : "POST",
								url : "/api/storeOrderDetails",
								contentType : "application/json",
								data : JSON.stringify(requestData),
								success : function(response) {
									console.log("Data stored successfully");
									alert("Congrats, course has been provided. Thank you!");
									window.location.href = '/myCourses';
								},
								error : function(error) {
									console.log("Error: " + error);
									alert("Some error occurred: " + error);
								}
							});
				},
				"prefill" : {
					"name" : uname,
					"email" : uemail,
					"contact" : uphoneno
				},
				"notes" : {
					"address" : "-----CampusConnect-----"
				},
				"theme" : {
					"color" : "#F37254"
				}
			};

			var rzp1 = new Razorpay(options);
			rzp1.on('payment.failed', function(response) {
				console.log(response);
				alert("Payment Failed: " + response.error.code + " - "
						+ response.error.description);
			});
			rzp1.open();
		}
	</script>

</body>

</html>