<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>View Feedbacks - Admin Panel</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" th:href="@{/css/admin-layout.css}" />

<style>
/* Status Badges */
.status-badge {
	padding: 6px 14px;
	border-radius: 20px;
	font-size: 0.85rem;
	font-weight: 600;
	display: inline-flex;
	align-items: center;
	gap: 5px;
	cursor: pointer;
	transition: all 0.3s ease;
}

.status-badge.unread {
	background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
	color: white;
	animation: pulse 2s infinite;
}

.status-badge.read {
	background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
	color: white;
}

.status-badge:hover {
	transform: translateY(-2px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

@
keyframes pulse { 0%, 100% {
	box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
}

50




%
{
box-shadow




:




0




0




0




10px




rgba


(




220
,
53
,
69
,
0




)


;
}
}
.feedback-preview {
	max-width: 300px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

.modal-body p {
	margin-bottom: 15px;
	padding: 10px;
	background: #f8f9fa;
	border-radius: 8px;
}

.modal-body strong {
	color: #2c3e50;
	display: inline-block;
	min-width: 80px;
}

.feedback-content {
	background: #e9ecef !important;
	padding: 15px !important;
	border-left: 4px solid #007bff;
	font-style: italic;
}
</style>
</head>

<body>
	<!-- Sidebar -->
	<div th:replace="~{fragments/admin-sidebar :: admin-sidebar}"></div>

	<!-- Main Content -->
	<div class="content">
		<div class="container-fluid">
			<!-- Header -->
			<div class="mb-4">
				<h2>
					<i class="bi bi-chat-quote-fill text-primary"></i> Customer
					Feedbacks
				</h2>
				<p class="text-muted mb-0">View and manage customer feedback</p>
			</div>

			<div th:replace="~{fragments/SuccessandError :: SuccessandError}"></div>

			<section class="mt-4">
				<div class="card shadow">
					<div class="card-body p-0">
						<div th:if="${feedbackPage.content.isEmpty()}"
							class="text-center py-5 px-3">
							<i class="bi bi-chat-left-dots"
								style="font-size: 4rem; color: #ccc;"></i>
							<h4 class="mt-3 text-muted">No Feedbacks Yet</h4>
							<p class="text-muted">Customer feedbacks will appear here</p>
						</div>

						<div th:if="${!feedbackPage.content.isEmpty()}">
							<div class="table-responsive">
								<table
									class="table table-striped table-hover table-bordered mb-0">
									<thead class="table-dark">
										<tr>
											<th scope="col">Customer Name</th>
											<th scope="col">Email</th>
											<th scope="col">Feedback Preview</th>
											<th scope="col">Date & Time</th>
											<th scope="col" class="text-center">Status</th>
											<th scope="col" class="text-center">Action</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="feedback : ${feedbackPage.content}">
											<!-- Customer Name -->
											<td><strong th:text="${feedback.userName}">Name</strong>
											</td>

											<!-- Email -->
											<td><i class="bi bi-envelope text-primary"></i> <span
												th:text="${feedback.userEmail}">Email</span></td>

											<td>
												<div class="feedback-preview"
													th:text="${feedback.userFeedback != null && feedback.userFeedback.length() > 50 ? feedback.userFeedback.substring(0, 50) + '...' : feedback.userFeedback}">
													Feedback text...</div>
											</td>

											<td><small class="text-muted"> <i
													class="bi bi-calendar3"></i> <span
													th:text="${feedback.dateOfFeedback}">Date</span> <br /> <i
													class="bi bi-clock"></i> <span
													th:text="${feedback.timeOfFeedback}">Time</span>
											</small></td>

											<td class="text-center"><span
												th:if="${feedback.readStatus == 'unread'}"
												class="status-badge unread"> <i
													class="bi bi-envelope-fill"></i> Unread
											</span> <span th:if="${feedback.readStatus == 'read'}"
												class="status-badge read"> <i
													class="bi bi-envelope-open-fill"></i> Read
											</span></td>

											<!-- View Button -->
											<td class="text-center">
												<button type="button" class="btn btn-sm btn-info"
													data-bs-toggle="modal" data-bs-target="#feedbackModal"
													th:data-feedback-id="${feedback.id}"
													th:data-feedback="${feedback.userFeedback}"
													th:data-feedback-name="${feedback.userName}"
													th:data-feedback-email="${feedback.userEmail}"
													th:data-feedback-date="${feedback.dateOfFeedback}"
													th:data-feedback-time="${feedback.timeOfFeedback}"
													th:data-feedback-status="${feedback.readStatus}"
													title="View Full Feedback">
													<i class="bi bi-eye-fill text-white"></i>
												</button>
											</td>
										</tr>
									</tbody>
								</table>
							</div>

							<!-- Pagination -->
							<div class="d-flex justify-content-center p-3 border-top">
								<div
									th:replace="~{fragments/paginationfeedback :: paginationfeedback(${feedbackPage})}"></div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
	</div>

	<!-- Feedback Detail Modal -->
	<div class="modal fade" id="feedbackModal" tabindex="-1"
		aria-labelledby="feedbackModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title" id="feedbackModalLabel">
						<i class="bi bi-chat-quote-fill"></i> Feedback Details
					</h5>
					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>
						<strong><i class="bi bi-person-fill text-primary"></i>
							Name:</strong> <span id="modalFeedbackName"></span>
					</p>
					<p>
						<strong><i class="bi bi-envelope-fill text-primary"></i>
							Email:</strong> <span id="modalFeedbackEmail"></span>
					</p>
					<p>
						<strong><i class="bi bi-calendar-event text-primary"></i>
							Date:</strong> <span id="modalFeedbackDate"></span> &nbsp;&nbsp; <strong><i
							class="bi bi-clock text-primary"></i> Time:</strong> <span
							id="modalFeedbackTime"></span>
					</p>
					<p class="feedback-content">
						<strong><i class="bi bi-chat-text text-primary"></i>
							Feedback:</strong><br /> <span id="modalFeedbackContent"></span>
					</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">
						<i class="bi bi-x-circle"></i> Close
					</button>

					<button type="button" class="btn btn-success" id="markReadBtn">
						<i class="bi bi-check-circle"></i> Mark as Read
					</button>

					<button type="button" class="btn btn-warning" id="markUnreadBtn">
						<i class="bi bi-envelope-fill"></i> Mark as Unread
					</button>

				</div>
			</div>
		</div>
	</div>

	<div id="loadingOverlay"
		style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999;">
		<div
			style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
			<div class="spinner-border text-light" role="status"
				style="width: 3rem; height: 3rem;">
				<span class="visually-hidden">Loading...</span>
			</div>
			<p class="text-white mt-3">Updating status...</p>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

	<script>
    document.addEventListener('DOMContentLoaded', function () {

    const feedbackModal = document.getElementById('feedbackModal');
    const markReadBtn = document.getElementById('markReadBtn');
    const markUnreadBtn = document.getElementById('markUnreadBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let currentFeedbackId = null;

    // ðŸ”¹ When modal opens
    feedbackModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        const feedback = button.getAttribute('data-feedback');
        const name = button.getAttribute('data-feedback-name');
        const email = button.getAttribute('data-feedback-email');
        const date = button.getAttribute('data-feedback-date');
        const time = button.getAttribute('data-feedback-time');
        const status = button.getAttribute('data-feedback-status');

        currentFeedbackId = button.getAttribute('data-feedback-id');

        document.getElementById('modalFeedbackName').textContent = name;
        document.getElementById('modalFeedbackEmail').textContent = email;
        document.getElementById('modalFeedbackContent').textContent = feedback;
        document.getElementById('modalFeedbackDate').textContent = date;
        document.getElementById('modalFeedbackTime').textContent = time;

        if (status === 'read') {
            markReadBtn.style.display = 'none';
            markUnreadBtn.style.display = 'inline-block';
        } else {
            markReadBtn.style.display = 'inline-block';
            markUnreadBtn.style.display = 'none';
        }
    });

    function updateStatus(newStatus) {
        loadingOverlay.style.display = 'block';

        fetch('/updateFeedbackStatus', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `id=${currentFeedbackId}&status=${newStatus}`
        })
        .then(response => response.text())
        .then(result => {
            loadingOverlay.style.display = 'none';

            if (result === 'success') {

                // ðŸ”¹ Update badge in table
                const activeButton = document.querySelector(
                    `button[data-feedback-id="${currentFeedbackId}"]`
                );

                activeButton.setAttribute('data-feedback-status', newStatus);

                const badgeCell = activeButton.closest('tr').querySelector('td.text-center span');

                if (newStatus === 'read') {
                    badgeCell.className = 'status-badge read';
                    badgeCell.innerHTML = '<i class="bi bi-envelope-open-fill"></i> Read';
                } else {
                    badgeCell.className = 'status-badge unread';
                    badgeCell.innerHTML = '<i class="bi bi-envelope-fill"></i> Unread';
                }

                // ðŸ”¹ Close modal
                const modal = bootstrap.Modal.getInstance(feedbackModal);
                modal.hide();

            } else if (result === 'unauthorized') {
                window.location.href = '/adminLogin';
            } else {
                alert('Failed to update status');
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error(error);
            alert('Server error');
        });
    }

    // ðŸ”¹ Button clicks
    markReadBtn.addEventListener('click', function () {
    	e.preventDefault();
        updateStatus('read');
    });

    markUnreadBtn.addEventListener('click', function () {
    	e.preventDefault();
        updateStatus('unread');
    });

});
</script>
</body>
</html>