<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Follow-Ups</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
	crossorigin="anonymous">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<link rel="stylesheet" th:href='@{/css/style.css}' />
<style>
#noFollowUpsTittle, #followUpsTable, #inquiryDetailsSection {
	display: none;
}
</style>
</head>

<body>

	<!-- Sidebar -->
	<div th:replace="~{fragments/employee-sidebar :: employee-sidebar}"></div>
	<!--End of Sidebar-->
	<!--Content-->
	<div class="content">
		<h2>Follow Ups</h2>
		<p>Below are the followUps list,Please handle the customers
			carefully..</p>

		<section class="mt-5">

			<div th:if="${successMsg}"
				class="mb-3 alert alert-success alert-dismissible fade show text-center"
				role="alert">
				<span th:text="${successMsg}"></span>
			</div>

			<div class="row justify-content-center">
				<div class="card shadow p-5" style="width: 60%">
					<div class="mb-3">
						<label class="form-label">Select Follow Up Date:</label> <input
							type="hidden" id="sessionempEmail"
							th:value="${sessionEmployee.emailId}" /> <input type="date"
							id="followUpDate" class="form-control" />
					</div>
					<h3 id="noFollowUpsTittle" class="text-danger mt-4">Sorry, No
						follow-Ups found..!!</h3>
					<table id="followUpsTable"
						class="table table-striped table-hover table-bordered shadow mt-4">
						<thead>
							<tr>
								<th>Customer Phone Number</th>
								<th>See More</th>
							</tr>
						</thead>
						<tbody id="followUpTableBody">

						</tbody>
					</table>
				</div>
			</div>
		</section>

		<section class="mt-5" id="inquiryDetailsSection">
			<div class="row justify-content-center">
				<div class="card shadow p-5" style="width: 100%">
					<h5 class="text-center text-primary">Discussion Details</h5>
					<h4 id="customerNameId" class="mt-4 text-info"></h4>
					<table
						class="table table-striped table-hover table-bordered shadow">
						<thead>
							<tr>
								<th>Customer Name</th>
								<th>interested Course</th>
								<th>Discussion</th>
								<th>Inquiry Type</th>
								<th>Call Type</th>
								<th>Date of Inquiry</th>
								<th>Time of Inquiry</th>
							</tr>
						</thead>
						<tbody id="inquiryTableBody">

						</tbody>
					</table>
					<button id="addNewDiscussion" class="btn btn-primary">Add
						New Discussion</button>
				</div>
			</div>
		</section>

		<div class="modal fade" id="inquiryModal" tabindex="-1"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">Continue
							Inquiry</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form th:action="@{/submitForm}" method="post"
							th:object="${inquiry}">
							<input type="hidden" name="sourcePage" value="followUpsPage" />
							<div class="mb-3">
								<label class="form-label">Customer Phone Number:</label> <input
									name="phoneno" id="modelCustomerPhoneNo" type="text"
									class="form-control" placeholder="Enter customer phone no."
									required />
							</div>
							<div class="mb-3">
								<label class="form-label">Customer Name:</label> <input
									name="name" id="modelCustomerName" type="text"
									class="form-control" placeholder="Enter customer name" required />
							</div>
							<div class="mb-3">
								<label class="form-label">Interested Course:</label> <input
									name="interestedCourse" type="text" class="form-control"
									placeholder="Enter interested Course" required />
							</div>
							<div class="mb-3">
								<label class="form-label">Discussion:</label>
								<textarea name="discussion" class="form-control"
									placeholder="Enter discussion" required></textarea>
							</div>
							<div class="mb-3">
								<label class="form-label">Inquiry Type:</label> <select
									name="inquiryType" class="form-select" required>
									<option value="" selected disabled>Select Inquiry
										Type:</option>
									<option value="Call">Call</option>
									<option value="Mail">Mail</option>
									<option value="Website">Website</option>
									<option value="Social Network">Social Network</option>
									<option value="Friend Reference">Friend Reference</option>
									<option value="Advertisement">Advertisement</option>
									<option value="Other">Other</option>
								</select>
							</div>
							<div class="mb-3">
								<label class="form-label">Call Type:</label> <select
									name="callType" class="form-select" required>
									<option value="" selected disabled>Select Call Type:</option>
									<option value="Inbound Call">Inbound Call (customer
										call to company)</option>
									<option value="Outbound Call">Outbound Call (company
										call to customer)</option>
								</select>
							</div>
							<div class="mb-3">
								<label class="form-label">Status:</label> <select name="status"
									id="status" class="form-select" onchange="toggleFollowUpdate()"
									required>
									<option value="" selected disabled>Select Status:</option>
									<option value="Interested - (follow up)">Interested -
										(follow up)</option>
									<option value="Interested - (closed)">Interested -
										(closed)</option>
									<option value="Not Interested - (closed)">Not
										Interested - (closed)</option>
									<option value="Purchased - (closed)">Purchased -
										(closed)</option>
									<option value="Others - (closed)">Others - (closed)</option>
								</select>
							</div>
							<div class="mb-3" id="followUpDateDiv">
								<label class="form-label">Follow Up Date:</label> <input
									name="followUpDate" type="Date" class="form-control"
									placeholder="Enter Follow upDate" />
							</div>
							<button type="submit" class="btn btn-primary">Submit</button>
						</form>
					</div>
				</div>
			</div>

		</div>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
			crossorigin="anonymous"></script>

		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<script>
    $(document).ready(function () {
        var todaysDate = new Date().toISOString().split('T')[0];
        $("#followUpDate").val(todaysDate);

        var email = $("#sessionempEmail").val();
        
        fetchFollowUps(email,todaysDate)
         
        $("#followUpDate").on("change", function() {
             var selectedDate = $(this).val();
             $("#inquiryDetailsSection").hide();
             fetchFollowUps(email, selectedDate);
        });

        function fetchFollowUps(email, followUpDate){
            $.ajax({
                url: "/api/myFollowUps",
                method: "GET",
                data: {
                    empEmail: email,
                    followUpDate: followUpDate
                },
                success: function (response) {
                    $("#followUpTableBody").empty();
                    if (response.length > 0) {
                        $.each(response, function (index, followUp) {
                            var row = `<tr>
                                <td>${followUp.phoneno}</td>
                                <td><button class="btn btn-primary getDiscussionBtn" data-phoneno="${followUp.phoneno}">Get All Discussion..</button></td>
                            </tr>`;
                            $("#followUpsTable").show();
                            $("#followUpTableBody").append(row);
                            $("#noFollowUpsTittle").hide();
                        });
                    } else {
                        $("#followUpsTable").hide();
                        $("#noFollowUpsTittle").show();
                        $("#inquiryDetailsSection").hide();
                    }
                },
                error: function (xhr, status, error) {
                	console.error("Error fetching follow-ups:", error, xhr.responseText);
                }
            });
        }
        
        $(document).on("click",".getDiscussionBtn",function(){
             var phoneno = $(this).data("phoneno");
             fetchInquires(phoneno);
        });

        function fetchInquires(phoneno){
             $.ajax({
                 url:"/api/searchInquiries",
                 method:"GET",
                 data:{
                	 phoneNumber : phoneno
                 },
                 success:function(response){
                	 $("#inquiryTableBody").empty();
                        if(response.length>0){
                           $("#inquiryDetailsSection").show();
                           $("#modelCustomerPhoneNo").val(response[0].phoneno);
                           $("#modelCustomerName").val(response[0].name);
                           $("#customerNameId").text("Customer Name : " +response[0].name);
                           
                           $.each(response, function (index,inquiry) {
                               var row = `<tr>
                                   <td>${inquiry.name}</td>
                                   <td>${inquiry.interestedCourse}</td>
                                   <td>${inquiry.discussion}</td>
                                   <td>${inquiry.inquiryType}</td>
                                   <td>${inquiry.callType}</td>
                                   <td>${inquiry.dateofInquiry}</td>
                                   <td>${inquiry.timeofInquiry}</td>
                               </tr>`;
                               $("#inquiryTableBody").append(row);
                           });
                         }else{
                            alert("No data found..")
                         }                     
                 },
                 error:function(xhr, status, error){ 
                    console.error("Error fetching inquiries:", error, xhr.responseText);
                 }
              });
        }
        
        $(document).on("click","#addNewDiscussion",function(){
            $("#inquiryModal").modal("show");
        });

    });
    
    function toggleFollowUpdate() {
		var status = document.getElementById("status").value;
		var followUpDateDiv = document.getElementById("followUpDateDiv");

		if (status === "Interested - (follow up)") {
			followUpDateDiv.style.display = "block";
		} else {
			followUpDateDiv.style.display = "none";
		}
	}
</script>
</body>

</html>
