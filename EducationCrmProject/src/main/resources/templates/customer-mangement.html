<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Customer Management - Admin Panel</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
	<link rel="stylesheet" th:href="@{/css/admin-layout.css}" />
</head>

<body>
	<!-- Sidebar -->
	<div th:replace="~{fragments/admin-sidebar :: admin-sidebar}"></div>

	<!-- Main Content -->
	<div class="content">
		<div class="container-fluid">
			<!-- Header -->
			<div class="mb-4">
				<h2>Customer Management</h2>
				<p class="text-muted mb-0">View, ban and unban customers</p>
			</div>

			<!-- Success/Error Messages -->
			<div th:replace="~{fragments/SuccessandError :: SuccessandError}"></div>

			<!-- Customers Table Section -->
			<section class="mt-4">
				<div class="card shadow">
					<div class="card-body p-0">
						<!-- Empty state -->
						<div th:if="${userPage.content.isEmpty()}" class="text-center py-5 px-3">
							<i class="bi bi-people-fill" style="font-size: 4rem; color: #ccc;"></i>
							<h4 class="mt-3 text-muted">No customers found</h4>
							<p class="text-muted">Customers will appear here once they register</p>
						</div>

						<!-- Customers table -->
						<div th:if="${!userPage.content.isEmpty()}">
							<div class="table-responsive">
								<table class="table table-striped table-hover table-bordered mb-0">
									<thead class="table-dark">
										<tr>
											<th scope="col">Name</th>
											<th scope="col">Email</th>
											<th scope="col">Phone No.</th>
											<th scope="col">City</th>
											<th scope="col">Status</th>
											<th scope="col" class="text-center">Actions</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="user : ${userPage.content}">
											<td>
												<strong th:text="${user.name}">Name</strong>
											</td>
											<td th:text="${user.email}">Email</td>
											<td th:text="${user.phoneno != null && !user.phoneno.isEmpty() ? user.phoneno : '-'}">Phone</td>
											<td th:text="${user.city != null && !user.city.isEmpty() ? user.city : '-'}">City</td>
											<td>
												<span th:if="${user.banStatus}" class="badge bg-danger">Banned</span>
												<span th:unless="${user.banStatus}" class="badge bg-success">Active</span>
											</td>
											<td class="text-center">
												<div class="btn-group" role="group">
													<!-- View Details Button -->
													<a th:href="@{/userCoursesDetails(userEmail=${user.email}, userName=${user.name})}" 
													   class="btn btn-sm btn-info" 
													   title="View Courses">
														<i class="bi bi-info-circle text-white"></i>
													</a>
													
													<!-- Ban Button (show only if not banned) -->
													<button th:if="${!user.banStatus}"
													        class="btn btn-sm btn-danger" 
													        th:data-uemail="${user.email}"
													        th:data-uname="${user.name}"
													        onclick="confirmBan(this.getAttribute('data-uemail'), this.getAttribute('data-uname'))"
													        title="Ban User">
														<i class="bi bi-x-circle"></i>
													</button>
													
													<!-- Unban Button (show only if banned) -->
													<button th:if="${user.banStatus}"
													        class="btn btn-sm btn-success" 
													        th:data-uemail="${user.email}"
													        th:data-uname="${user.name}"
													        onclick="confirmUnban(this.getAttribute('data-uemail'), this.getAttribute('data-uname'))"
													        title="Unban User">
														<i class="bi bi-check-circle"></i>
													</button>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>

							<!-- Pagination -->
							<div class="d-flex justify-content-center p-3 border-top">
								<div th:replace="~{fragments/paginationUser :: paginationUser(${userPage})}"></div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
	</div>

	<!-- Ban User Modal -->
	<div class="modal fade" id="banUserModal" tabindex="-1" aria-labelledby="banUserModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title" id="banUserModalLabel">
						<i class="bi bi-exclamation-triangle-fill"></i> Ban User
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to ban this user?</p>
					<p><strong id="banUserName" class="text-danger"></strong></p>
					<p class="text-muted small">This user will not be able to access the system.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						<i class="bi bi-x-circle"></i> Cancel
					</button>
					<button type="button" class="btn btn-danger" id="banUserBtn">
						<i class="bi bi-x-circle"></i> Ban User
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Unban User Modal -->
	<div class="modal fade" id="unbanUserModal" tabindex="-1" aria-labelledby="unbanUserModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-success text-white">
					<h5 class="modal-title" id="unbanUserModalLabel">
						<i class="bi bi-check-circle-fill"></i> Unban User
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to unban this user?</p>
					<p><strong id="unbanUserName" class="text-success"></strong></p>
					<p class="text-muted small">This user will regain access to the system.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						<i class="bi bi-x-circle"></i> Cancel
					</button>
					<button type="button" class="btn btn-success" id="unbanUserBtn">
						<i class="bi bi-check-circle"></i> Unban User
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Loading Overlay -->
	<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
		<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
			<div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
				<span class="visually-hidden">Loading...</span>
			</div>
			<p class="text-white mt-3">Processing...</p>
		</div>
	</div>

	<!-- JavaScript -->
	<script>
		let userEmailToBan = null;
		let banUserModal = null;
		let unbanUserModal = null;

		document.addEventListener('DOMContentLoaded', function() {
			banUserModal = new bootstrap.Modal(document.getElementById('banUserModal'));
			unbanUserModal = new bootstrap.Modal(document.getElementById('unbanUserModal'));
		});

		// ✅ Ban User Confirmation
		function confirmBan(email, name) {
			if (!email) {
				alert('Invalid user email');
				return;
			}
			userEmailToBan = email;
			document.getElementById('banUserName').textContent = name || email;
			banUserModal.show();
		}

		// ✅ Unban User Confirmation
		function confirmUnban(email, name) {
			if (!email) {
				alert('Invalid user email');
				return;
			}
			userEmailToBan = email;
			document.getElementById('unbanUserName').textContent = name || email;
			unbanUserModal.show();
		}

		// ✅ Ban User Action
		document.getElementById('banUserBtn').addEventListener('click', function() {
			if (!userEmailToBan) {
				alert('No user selected');
				return;
			}
			document.getElementById('loadingOverlay').style.display = 'block';
			banUserModal.hide();
			window.location.href = '/banUserDetails?userEmail=' + encodeURIComponent(userEmailToBan) + '&banStatus=true';
		});

		// ✅ Unban User Action
		document.getElementById('unbanUserBtn').addEventListener('click', function() {
			if (!userEmailToBan) {
				alert('No user selected');
				return;
			}
			document.getElementById('loadingOverlay').style.display = 'block';
			unbanUserModal.hide();
			window.location.href = '/banUserDetails?userEmail=' + encodeURIComponent(userEmailToBan) + '&banStatus=false';
		});

		// ✅ Auto-hide alerts after 5 seconds
		setTimeout(function() {
			const alerts = document.querySelectorAll('.alert');
			alerts.forEach(function(alert) {
				if (alert) {
					const bsAlert = new bootstrap.Alert(alert);
					bsAlert.close();
				}
			});
		}, 5000);
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>